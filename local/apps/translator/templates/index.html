{% extends "base.html" %}
{% block title %}Translator ‚Äì Local AI{% endblock %}
{% block body %}
<div class="app-layout">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header"><span class="logo">‚ö° Local AI</span></div>
        <nav class="sidebar-nav">
            <a href="{{ url_for('chat') }}" class="nav-item">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
                Chat
                </a>
            <a href="{{ url_for('imagegen') }}" class="nav-item">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                Image Gen
                </a>
            <a href="{{ url_for('apps_page') }}" class="nav-item active">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
                Apps
                </a>
        </nav>
        <div class="sidebar-footer">
            <div class="user-info">
                <span class="user-avatar">{{ user.username[0]|upper }}</span>
                <span class="user-name">{{ user.username }}</span>
            </div>
            <div style="display:flex;gap:4px;">
                <button class="btn-theme" id="btn-theme" title="Toggle theme">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
                </button>
                <a href="{{ url_for('logout') }}" class="btn-icon" title="Logout">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                </a>
            </div>
        </div>
    </aside>

    <main class="app-page">
        <div class="app-topbar">
            <a href="{{ url_for('apps_page') }}" class="app-back">&larr; Apps</a>
            <span class="app-title-bar">üåç Translator</span>
        </div>

        <div class="tr-container">
            <div class="tr-lang-bar">
                <select id="tr-source">
                    <option value="Auto-detect">Auto-detect</option>
                    {% for lang in languages %}
                    <option value="{{ lang }}">{{ lang }}</option>
                    {% endfor %}
                </select>
                <button class="tr-swap" id="tr-swap" title="Swap languages">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="7 16 3 12 7 8"/><line x1="3" y1="12" x2="21" y2="12"/><polyline points="17 8 21 12 17 16"/></svg>
                </button>
                <select id="tr-target">
                    {% for lang in languages %}
                    <option value="{{ lang }}" {{ 'selected' if lang == 'Spanish' }}>{{ lang }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="tr-panels">
                <div class="tr-panel">
                    <textarea id="tr-input" placeholder="Enter text to translate..." rows="8"></textarea>
                    <div class="tr-count"><span id="tr-char-count">0</span> chars</div>
                </div>
                <div class="tr-panel tr-panel-output">
                    <div id="tr-output" class="tr-output-text">Translation will appear here...</div>
                    <button class="tr-copy hidden" id="tr-copy" title="Copy">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                        Copy
                    </button>
                </div>
            </div>

            <button class="btn btn-primary tr-go" id="tr-go">Translate</button>
            <div class="tr-status hidden" id="tr-status"></div>
        </div>
    </main>
</div>

<script>
const $input = document.getElementById('tr-input');
const $output = document.getElementById('tr-output');
const $go = document.getElementById('tr-go');
const $status = document.getElementById('tr-status');
const $copy = document.getElementById('tr-copy');
const $charCount = document.getElementById('tr-char-count');

$input.addEventListener('input', () => {
    $charCount.textContent = $input.value.length;
});

document.getElementById('tr-swap').addEventListener('click', () => {
    const src = document.getElementById('tr-source');
    const tgt = document.getElementById('tr-target');
    if (src.value === 'Auto-detect') return;
    const tmp = src.value;
    src.value = tgt.value;
    tgt.value = tmp;
    // Also swap text
    if ($output.textContent && $output.textContent !== 'Translation will appear here...') {
        const outText = $output.textContent;
        $output.textContent = $input.value;
        $input.value = outText;
        $charCount.textContent = $input.value.length;
    }
});

$go.addEventListener('click', translate);
$input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && e.ctrlKey) { e.preventDefault(); translate(); }
});

async function translate() {
    const text = $input.value.trim();
    if (!text) return;

    $go.disabled = true;
    $go.textContent = 'Translating...';
    $output.textContent = '';
    $copy.classList.add('hidden');
    $status.classList.add('hidden');

    try {
        const res = await fetch('/api/apps/translator/run', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                text,
                source: document.getElementById('tr-source').value,
                target: document.getElementById('tr-target').value,
            }),
        });

        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let full = '';

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            for (const line of decoder.decode(value).split('\n')) {
                if (!line.startsWith('data: ')) continue;
                const data = JSON.parse(line.slice(6));
                if (data.error) {
                    $status.textContent = 'Error: ' + data.error;
                    $status.classList.remove('hidden');
                    break;
                }
                if (data.token) { full += data.token; $output.textContent = full; }
                if (data.done) { $copy.classList.remove('hidden'); }
            }
        }
    } catch (err) {
        $status.textContent = 'Error: ' + err.message;
        $status.classList.remove('hidden');
    }

    $go.disabled = false;
    $go.textContent = 'Translate';
}

$copy.addEventListener('click', () => {
    navigator.clipboard.writeText($output.textContent);
    $copy.textContent = 'Copied!';
    setTimeout(() => { $copy.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg> Copy'; }, 1500);
});
</script>
{% endblock %}
