{% extends "base.html" %}
{% block title %}Recipes ‚Äì Local AI{% endblock %}
{% block body %}
<div class="app-layout">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header"><span class="logo">‚ö° Local AI</span></div>
        <nav class="sidebar-nav">
            <a href="{{ url_for('chat') }}" class="nav-item">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
                Chat
                </a>
            <a href="{{ url_for('imagegen') }}" class="nav-item">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                Image Gen
                </a>
            <a href="{{ url_for('apps_page') }}" class="nav-item active">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
                Apps
                </a>
        </nav>
        <div class="sidebar-footer">
            <div class="user-info">
                <span class="user-avatar">{{ user.username[0]|upper }}</span>
                <span class="user-name">{{ user.username }}</span>
            </div>
            <div style="display:flex;gap:4px;">
                <button class="btn-theme" id="btn-theme" title="Toggle theme">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
                </button>
                <a href="{{ url_for('logout') }}" class="btn-icon" title="Logout">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                </a>
            </div>
        </div>
    </aside>

    <main class="app-page">
        <div class="app-topbar">
            <a href="{{ url_for('apps_page') }}" class="app-back">&larr; Apps</a>
            <span class="app-title-bar">üç≥ Recipes & Meal Prep</span>
        </div>

        <div class="rc-container">
            <!-- Input panel -->
            <div class="rc-input-panel" id="rc-input-panel">
                <h2>What's in your kitchen?</h2>
                <div class="ig-field">
                    <label>Ingredients</label>
                    <textarea id="rc-ingredients" placeholder="chicken, rice, broccoli, soy sauce, garlic..." rows="3"></textarea>
                </div>
                <div class="ig-row">
                    <div class="ig-field">
                        <label>Dietary</label>
                        <select id="rc-dietary">
                            <option value="None">None</option>
                            <option value="Vegetarian">Vegetarian</option>
                            <option value="Vegan">Vegan</option>
                            <option value="Keto">Keto</option>
                            <option value="Gluten-free">Gluten-free</option>
                        </select>
                    </div>
                    <div class="ig-field">
                        <label>Meal</label>
                        <select id="rc-meal">
                            <option value="Any">Any</option>
                            <option value="Breakfast">Breakfast</option>
                            <option value="Lunch">Lunch</option>
                            <option value="Dinner" selected>Dinner</option>
                            <option value="Snack">Snack</option>
                        </select>
                    </div>
                    <div class="ig-field">
                        <label>Servings</label>
                        <input type="number" id="rc-servings" value="4" min="1" max="12">
                    </div>
                </div>
                <button class="btn btn-primary rc-go" id="rc-go">Get Recipe</button>
                <div class="rc-status hidden" id="rc-status"></div>
                <div class="rc-loading hidden" id="rc-loading">
                    <span class="status-dot"></span> Cooking up a recipe...
                </div>
            </div>

            <!-- Recipe output -->
            <div class="rc-recipe hidden" id="rc-recipe">
                <div class="rc-recipe-header">
                    <h2 id="rc-title"></h2>
                    <div class="rc-badges">
                        <span class="rc-badge" id="rc-prep"></span>
                        <span class="rc-badge" id="rc-cook"></span>
                        <span class="rc-badge" id="rc-servings-out"></span>
                    </div>
                </div>

                <div class="rc-two-col">
                    <div class="rc-ingredients-panel">
                        <h3>Ingredients</h3>
                        <ul id="rc-ing-list"></ul>
                    </div>
                    <div class="rc-steps-panel">
                        <h3>Steps</h3>
                        <ol id="rc-steps-list"></ol>
                    </div>
                </div>

                <div class="rc-tips hidden" id="rc-tips-wrap">
                    <h3>Tips</h3>
                    <p id="rc-tips"></p>
                </div>

                <div class="rc-actions">
                    <button class="btn fc-btn" id="rc-again">New Recipe</button>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
const $go = document.getElementById('rc-go');
const $status = document.getElementById('rc-status');
const $loading = document.getElementById('rc-loading');
const $inputPanel = document.getElementById('rc-input-panel');
const $recipePanel = document.getElementById('rc-recipe');

$go.addEventListener('click', generate);
document.getElementById('rc-ingredients').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && e.ctrlKey) { e.preventDefault(); generate(); }
});

async function generate() {
    const ingredients = document.getElementById('rc-ingredients').value.trim();
    if (!ingredients) return;

    $go.disabled = true;
    $status.classList.add('hidden');
    $loading.classList.remove('hidden');

    try {
        const res = await fetch('/api/apps/recipes/run', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                ingredients,
                dietary: document.getElementById('rc-dietary').value,
                servings: parseInt(document.getElementById('rc-servings').value),
                meal_type: document.getElementById('rc-meal').value,
            }),
        });

        const reader = res.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            for (const line of decoder.decode(value).split('\n')) {
                if (!line.startsWith('data: ')) continue;
                const data = JSON.parse(line.slice(6));
                if (data.error) {
                    $status.textContent = 'Error: ' + data.error;
                    $status.classList.remove('hidden');
                    $loading.classList.add('hidden');
                    $go.disabled = false;
                    return;
                }
                if (data.done && data.recipe) {
                    renderRecipe(data.recipe);
                }
            }
        }
    } catch (err) {
        $status.textContent = 'Error: ' + err.message;
        $status.classList.remove('hidden');
    }

    $loading.classList.add('hidden');
    $go.disabled = false;
}

function renderRecipe(r) {
    $inputPanel.classList.add('hidden');
    $recipePanel.classList.remove('hidden');

    document.getElementById('rc-title').textContent = r.title || 'Recipe';
    document.getElementById('rc-prep').textContent = 'üî™ Prep: ' + (r.prep_time || '?');
    document.getElementById('rc-cook').textContent = 'üî• Cook: ' + (r.cook_time || '?');
    document.getElementById('rc-servings-out').textContent = 'üçΩÔ∏è Serves: ' + (r.servings || '?');

    const $ingList = document.getElementById('rc-ing-list');
    $ingList.innerHTML = (r.ingredients || []).map(i =>
        `<li><label class="rc-check"><input type="checkbox"><span>${esc(i)}</span></label></li>`
    ).join('');

    const $stepsList = document.getElementById('rc-steps-list');
    $stepsList.innerHTML = (r.steps || []).map(s => `<li>${esc(s)}</li>`).join('');

    if (r.tips) {
        document.getElementById('rc-tips').textContent = r.tips;
        document.getElementById('rc-tips-wrap').classList.remove('hidden');
    } else {
        document.getElementById('rc-tips-wrap').classList.add('hidden');
    }
}

function esc(s) {
    const d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
}

document.getElementById('rc-again').addEventListener('click', () => {
    $recipePanel.classList.add('hidden');
    $inputPanel.classList.remove('hidden');
});
</script>
{% endblock %}
