{% extends "base.html" %}
{% block title %}Chat – Local AI{% endblock %}
{% block body %}
<div class="app-layout">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <span class="logo">⚡ Local AI</span>
            <button class="btn-icon" id="btn-new-chat" title="New Chat">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            </button>
        </div>

        <nav class="sidebar-nav">
            <a href="{{ url_for('chat') }}" class="nav-item active">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
                Chat
            </a>
            <a href="{{ url_for('imagegen') }}" class="nav-item">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                Image Gen
            </a>
            <a href="{{ url_for('apps_page') }}" class="nav-item">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
                Apps
            </a>
        </nav>

        <!-- Search -->
        <div class="sidebar-search">
            <input type="text" id="search-input" placeholder="Search chats..." autocomplete="off">
            <div id="search-results" class="search-results hidden"></div>
        </div>

        <!-- Conversations list -->
        <div class="sidebar-convos" id="convo-list">
            {% for c in conversations %}
            <a href="{{ url_for('chat', convo_id=c.id) }}"
               class="convo-item {% if active_convo and active_convo.id == c.id %}active{% endif %}"
               data-id="{{ c.id }}">
                <span class="convo-title">{{ c.title }}</span>
                <button class="btn-icon convo-delete" data-id="{{ c.id }}" title="Delete">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </a>
            {% endfor %}
        </div>

        <!-- User -->
        <div class="sidebar-footer">
            <div class="user-info">
                <span class="user-avatar">{{ user.username[0]|upper }}</span>
                <span class="user-name">{{ user.username }}</span>
            </div>
            <div style="display:flex;gap:4px;">
                <button class="btn-theme" id="btn-theme" title="Toggle theme">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
                </button>
                <a href="{{ url_for('logout') }}" class="btn-icon" title="Logout">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                </a>
            </div>
        </div>
    </aside>

    <!-- Mobile sidebar toggle -->
    <button class="sidebar-toggle" id="sidebar-toggle">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
    </button>

    <!-- Main chat area -->
    <main class="chat-main">
        <!-- Top bar: model + personality selectors -->
        <div class="chat-topbar">
            <div class="topbar-controls">
                <div class="select-group">
                    <label>Backend</label>
                    <select id="backend-select"></select>
                    <button class="btn-icon" id="btn-manage-backends" title="Manage Backends">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    </button>
                </div>
                <div class="select-group">
                    <label>Model</label>
                    <select id="model-select">
                        <option value="{{ user.default_model }}">{{ user.default_model }}</option>
                    </select>
                    <button class="btn-icon" id="btn-manage-models" title="Manage Models">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
                    </button>
                </div>
                <div class="select-group">
                    <label>Personality</label>
                    <select id="personality-select">
                        {% for key, p in personalities.items() %}
                        <option value="{{ key }}" {% if active_convo and active_convo.personality == key %}selected{% elif not active_convo and user.default_personality == key %}selected{% endif %}>
                            {{ p.icon }} {{ p.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <!-- Messages -->
        <div class="chat-messages" id="chat-messages">
            {% if not active_convo %}
            <div class="empty-state">
                <div class="empty-icon">⚡</div>
                <h2>Local AI</h2>
                <p>Private. Fast. Yours.</p>
                <div class="personality-grid">
                    {% for key, p in personalities.items() %}
                    <button class="personality-card" data-personality="{{ key }}">
                        <span class="personality-icon">{{ p.icon }}</span>
                        <span class="personality-name">{{ p.name }}</span>
                    </button>
                    {% endfor %}
                </div>
            </div>
            {% else %}
                {% for m in messages %}
                <div class="message message-{{ m.role }}">
                    <div class="message-inner">
                        <div class="message-avatar">
                            {% if m.role == 'user' %}{{ user.username[0]|upper }}{% else %}{{ personalities[active_convo.personality].icon }}{% endif %}
                        </div>
                        <div class="message-body">
                            <div class="message-role">{% if m.role == 'user' %}You{% else %}{{ personalities[active_convo.personality].name }}{% endif %}</div>
                            <div class="message-content">{{ m.content }}</div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% endif %}
        </div>

        <!-- Status bar (search/think progress) -->
        <div class="chat-status hidden" id="chat-status"></div>

        <!-- Input -->
        <div class="chat-input-area">
            <div class="input-toggles" id="input-toggles">
                <button class="toggle-btn" id="toggle-search" title="Web Search">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                    Search
                </button>
                <button class="toggle-btn" id="toggle-think" title="Think/Reason">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a7 7 0 017 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 01-1 1H9a1 1 0 01-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 017-7z"/><line x1="9" y1="21" x2="15" y2="21"/></svg>
                    Think
                </button>
            </div>
            <form id="chat-form" class="chat-form">
                <textarea id="chat-input" placeholder="Type a message..." rows="1" autofocus></textarea>
                <button type="submit" class="btn btn-send" id="btn-send" title="Send">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg>
                </button>
            </form>
            <div class="input-hint">Press Enter to send, Shift+Enter for new line</div>
        </div>
    </main>
</div>

<!-- Model Manager Modal -->
<div class="modal-overlay hidden" id="model-modal">
    <div class="modal">
        <div class="modal-header">
            <h3>Models</h3>
            <button class="btn-icon" id="modal-close">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        <div class="modal-pull">
            <input type="text" id="pull-input" placeholder="Pull a model (e.g. llama3.2, mistral, codellama)">
            <button class="btn btn-primary" id="btn-pull">Pull</button>
        </div>
        <div id="pull-status" class="pull-status hidden"></div>
        <div class="modal-models" id="modal-model-list">
            <div class="model-loading">Loading models...</div>
        </div>
    </div>
</div>

<!-- Backend Manager Modal -->
<div class="modal-overlay hidden" id="backend-modal">
    <div class="modal">
        <div class="modal-header">
            <h3>Backends</h3>
            <button class="btn-icon" id="backend-modal-close">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        <div class="modal-section" style="padding:14px 20px; border-bottom:1px solid rgba(255,255,255,.06);">
            <div style="display:flex; gap:8px; margin-bottom:10px;">
                <select id="backend-kind" style="flex:1; padding:8px; background:var(--bg-input); border:1px solid var(--border); border-radius:8px; color:var(--text); font-size:13px;">
                    <option value="ollama">Ollama</option>
                    <option value="lmstudio">LM Studio</option>
                    <option value="llamacpp">llama.cpp</option>
                    <option value="openai">OpenAI</option>
                    <option value="custom">Custom (OpenAI-compatible)</option>
                </select>
                <button class="btn btn-primary" id="btn-add-backend" style="padding:8px 16px; font-size:13px;">Add</button>
            </div>
        </div>
        <div class="modal-models" id="backend-list">
            <div class="model-loading">Loading backends...</div>
        </div>
    </div>
</div>

<!-- Backend Edit Modal -->
<div class="modal-overlay hidden" id="backend-edit-modal">
    <div class="modal" style="max-width:440px;">
        <div class="modal-header">
            <h3 id="be-title">Edit Backend</h3>
            <button class="btn-icon" id="be-close">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        <div style="padding:16px 20px;">
            <input type="hidden" id="be-id">
            <div class="ig-field"><label>Name</label><input type="text" id="be-name"></div>
            <div class="ig-field"><label>URL</label><input type="text" id="be-url"></div>
            <div class="ig-field"><label>API Key (optional)</label><input type="password" id="be-key" placeholder="Leave blank if not needed"></div>
            <div style="display:flex; gap:8px; margin-top:12px;">
                <button class="btn btn-primary" id="be-save" style="padding:8px 16px; font-size:13px;">Save</button>
                <button class="btn" id="be-test" style="padding:8px 16px; font-size:13px; background:var(--bg-input); color:var(--text);">Test Connection</button>
            </div>
            <div id="be-status" style="margin-top:8px; font-size:13px;" class="hidden"></div>
        </div>
    </div>
</div>

<script>
    const ACTIVE_CONVO = {{ active_convo.id if active_convo else 'null' }};
    const DEFAULT_MODEL = "{{ user.default_model }}";
    const DEFAULT_PERSONALITY = "{{ user.default_personality }}";
</script>
<script src="{{ url_for('static', filename='js/chat.js') }}"></script>
{% endblock %}
