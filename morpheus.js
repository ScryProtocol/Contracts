const ethers = require('ethers');
require('dotenv').config()
let rpc = process.env.RPC
const fetch = require('node-fetch');
const keccak256 = require('keccak256')
let contractAddress = process.env.OOFAddress; // replace with your contract address
const ABI = require('./abi/NostradamusSS.json')
const { Contract, BigNumber } = require("ethers");
let feedInventory = [];
// storage for last update timestamp
let lastUpdate = {}; let balance
let pk = process.env.PK
let minfee = process.env.MINFEE
let contract;
// script.js
const args = process.argv.slice(2);

const flags = {};

for (let i = 0; i < args.length; i++) {
  if (args[i].startsWith('-')) {
    // If the next argument starts with '-', set the current flag's value to true.
    // Otherwise, set the current flag's value to the next argument's value.
    flags[args[i]] = args[i + 1] && !args[i + 1].startsWith('-') ? args[i + 1] : true;
  }
}

console.log('Parsed flags:', flags);

// Access individual flags like this:
const rpcFlag = flags['-r'];
const aFlag = flags['-a'];
const pkFlag = flags['-pk'];
if (rpcFlag != null) {
  rpc = rpcFlag
}
if (aFlag != null) {
  contractAddress = aFlag
}
if (pkFlag != null) {
  pk = pkFlag
}
const provider = new ethers.providers.JsonRpcProvider(rpc);

const bc = '0x6080604052600160045534801561001557600080fd5b5061412b806100256000396000f3fe6080604052600436106101145760003560e01c80638c604296116100a0578063c37219ba11610064578063c37219ba1461037b578063c4c1d0bf146103a4578063c6311e3f146103cf578063de11c94a14610411578063ecb76d901461043c57610114565b80638c604296146102a35780638e486eec146102bf5780639da6553b146102ea578063a4a4f39014610327578063ab2730161461035257610114565b80634a45ea5c116100e75780634a45ea5c146101c15780634eb90352146102035780635b8d02d71461022c578063639b55ba14610257578063882fd7821461028757610114565b80630f3c80b2146101195780632079fb9a1461014257806324600fc31461017f57806330c942e014610196575b600080fd5b34801561012557600080fd5b50610140600480360381019061013b9190612ec5565b61047c565b005b34801561014e57600080fd5b506101696004803603810190610164919061315b565b61086b565b60405161017691906138e6565b60405180910390f35b34801561018b57600080fd5b506101946108aa565b005b3480156101a257600080fd5b506101ab610ad3565b6040516101b89190613c68565b60405180910390f35b3480156101cd57600080fd5b506101e860048036038101906101e39190613017565b610ad9565b6040516101fa9695949392919061397c565b60405180910390f35b34801561020f57600080fd5b5061022a600480360381019061022591906130c4565b610ffd565b005b34801561023857600080fd5b506102416112fd565b60405161024e9190613901565b60405180910390f35b610271600480360381019061026c9190612f54565b611323565b60405161027e919061395a565b60405180910390f35b6102a1600480360381019061029c9190613058565b61167a565b005b6102bd60048036038101906102b89190612e89565b611812565b005b3480156102cb57600080fd5b506102d4611a2b565b6040516102e19190613c68565b60405180910390f35b3480156102f657600080fd5b50610311600480360381019061030c919061315b565b611a31565b60405161031e9190613c68565b60405180910390f35b34801561033357600080fd5b5061033c611a49565b6040516103499190613c68565b60405180910390f35b34801561035e57600080fd5b506103796004803603810190610374919061315b565b611a4f565b005b34801561038757600080fd5b506103a2600480360381019061039d9190613184565b611e2b565b005b3480156103b057600080fd5b506103b9612320565b6040516103c69190613c68565b60405180910390f35b3480156103db57600080fd5b506103f660048036038101906103f1919061315b565b61232d565b60405161040896959493929190613cac565b60405180910390f35b34801561041d57600080fd5b506104266123b9565b60405161043391906138e6565b60405180910390f35b34801561044857600080fd5b50610463600480360381019061045e919061315b565b6123dd565b6040516104739493929190613dce565b60405180910390f35b600073ffffffffffffffffffffffffffffffffffffffff1660008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161461050b576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161050290613b88565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff16141561057b576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161057290613ac8565b60405180910390fd5b60008414156105bf576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016105b690613aa8565b60405180910390fd5b8451841115610603576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016105fa90613b28565b60405180910390fd5b806000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550836004819055508460039080519060200190610660929190612afa565b5060005b6003805490508110156107b457600073ffffffffffffffffffffffffffffffffffffffff166003828154811061069657fe5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161415610718576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161070f90613ba8565b60405180910390fd5b6001600560006003848154811061072b57fe5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055508080600101915050610664565b50845160028190555082600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550816008819055507ff4955da0e7ea6f8c9297d8046c39168f24abc71dd60d47c7e4e2172f28f0c93385600454600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1660405161085c9392919061391c565b60405180910390a15050505050565b6003818154811061087b57600080fd5b906000526020600020016000915054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600073ffffffffffffffffffffffffffffffffffffffff16600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614156109f65760008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc6064478161094557fe5b049081150290604051600060405180830381858888f19350505050158015610971573d6000803e3d6000fd5b50600360008154811061098057fe5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc479081150290604051600060405180830381858888f193505050501580156109f0573d6000803e3d6000fd5b50610ad1565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc60644781610a3a57fe5b049081150290604051600060405180830381858888f19350505050158015610a66573d6000803e3d6000fd5b50600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc479081150290604051600060405180830381858888f19350505050158015610acf573d6000803e3d6000fd5b505b565b60025481565b60608060608060608060008751905060008167ffffffffffffffff81118015610b0157600080fd5b50604051908082528060200260200182016040528015610b305781602001602082028036833780820191505090505b50905060008267ffffffffffffffff81118015610b4c57600080fd5b50604051908082528060200260200182016040528015610b7b5781602001602082028036833780820191505090505b50905060008367ffffffffffffffff81118015610b9757600080fd5b50604051908082528060200260200182016040528015610bc65781602001602082028036833780820191505090505b50905060008467ffffffffffffffff81118015610be257600080fd5b50604051908082528060200260200182016040528015610c1657816020015b6060815260200190600190039081610c015790505b50905060008567ffffffffffffffff81118015610c3257600080fd5b50604051908082528060200260200182016040528015610c6657816020015b6060815260200190600190039081610c515790505b50905060008667ffffffffffffffff81118015610c8257600080fd5b50604051908082528060200260200182016040528015610cb657816020015b6060815260200190600190039081610ca15790505b50905060005b8e51811015610fda57610ce18f8281518110610cd457fe5b60200260200101516123dd565b50898481518110610cee57fe5b60200260200101898581518110610d0157fe5b60200260200101898681518110610d1457fe5b6020026020010183815250838152508381525050505060078f8281518110610d3857fe5b602002602001015181548110610d4a57fe5b90600052602060002090600602016000018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610def5780601f10610dc457610100808354040283529160200191610def565b820191906000526020600020905b815481529060010190602001808311610dd257829003601f168201915b5050505050848281518110610e0057fe5b602002602001018190525060078f8281518110610e1957fe5b602002602001015181548110610e2b57fe5b90600052602060002090600602016001018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610ed05780601f10610ea557610100808354040283529160200191610ed0565b820191906000526020600020905b815481529060010190602001808311610eb357829003601f168201915b5050505050838281518110610ee157fe5b602002602001018190525060078f8281518110610efa57fe5b602002602001015181548110610f0c57fe5b90600052602060002090600602016005018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610fb15780601f10610f8657610100808354040283529160200191610fb1565b820191906000526020600020905b815481529060010190602001808311610f9457829003601f168201915b5050505050828281518110610fc257fe5b60200260200101819052508080600101915050610cbc565b508585858585859c509c509c509c509c509c505050505050505091939550919395565b61100561251b565b8251825114611049576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161104090613a88565b60405180910390fd5b60005b825181101561123f577f1460389a0c6c9278fbbacb076aa3f9f3f3696a186cd48b77be133a0cf86ba61684828151811061108257fe5b602002602001015184838151811061109657fe5b602002602001015142336040516110b09493929190613d89565b60405180910390a14260078583815181106110c757fe5b6020026020010151815481106110d957fe5b9060005260206000209060060201600301819055508281815181106110fa57fe5b6020026020010151600785838151811061111057fe5b60200260200101518154811061112257fe5b90600052602060002090600602016002018190555081818151811061114357fe5b6020026020010151600785838151811061115957fe5b60200260200101518154811061116b57fe5b9060005260206000209060060201600501908051906020019061118f929190612b84565b507f90c6c99253838b5afd993e669459569a2b6daf2f347461481c61e5aec2c001498482815181106111bd57fe5b60200260200101518483815181106111d157fe5b6020026020010151428585815181106111e657fe5b60200260200101516040516111fe9493929190613dce565b60405180910390a160006006600086848151811061121857fe5b6020026020010151815260200190815260200160002081905550808060010191505061104c565b5060008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc6064478161128457fe5b049081150290604051600060405180830381858888f193505050501580156112b0573d6000803e3d6000fd5b503373ffffffffffffffffffffffffffffffffffffffff166108fc479081150290604051600060405180830381858888f193505050501580156112f7573d6000803e3d6000fd5b50505050565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60608351855114611369576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161136090613be8565b60405180910390fd5b600080855167ffffffffffffffff8111801561138457600080fd5b506040519080825280602002602001820160405280156113b35781602001602082028036833780820191505090505b50905060005b875181101561166c5760076040518060c001604052808a84815181106113db57fe5b602002602001015181526020018984815181106113f457fe5b60200260200101518152602001600081526020016000815260200188848151811061141b57fe5b602002602001015181526020016040518060200160405280600081525081525090806001815401808255809150506001900390600052602060002090600602016000909190919091506000820151816000019080519060200190611480929190612b84565b50602082015181600101908051906020019061149d929190612b84565b5060408201518160020155606082015181600301556080820151816004015560a08201518160050190805190602001906114d8929190612b84565b5050508481815181106114e757fe5b60200260200101518301925061153485828151811061150257fe5b6020026020010151600660006001600780549050038152602001908152602001600020546125a990919063ffffffff16565b6006600060016007805490500381526020019081526020016000208190555060016007805490500382828151811061156857fe5b60200260200101818152505042600960003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054106115bf57600092505b348311156115cc57600080fd5b7f98ac65ad6bf71843f1769c45ecb493aa19386b60a5eab908f85b751c90921df98882815181106115f957fe5b602002602001015188838151811061160d57fe5b602002602001015187848151811061162157fe5b602002602001015189858151811061163557fe5b6020026020010151600160078054905003604051611657959493929190613a07565b60405180910390a180806001019150506113b9565b508092505050949350505050565b80518251146116be576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016116b590613be8565b60405180910390fd5b600080600090505b83518110156117c95761171b8382815181106116de57fe5b6020026020010151600660008785815181106116f657fe5b60200260200101518152602001908152602001600020546125a990919063ffffffff16565b6006600086848151811061172b57fe5b602002602001015181526020019081526020016000208190555082818151811061175157fe5b6020026020010151820191507f3444f0007ac07416465c167c0d7657d48e9d410b498f8849035fc9cf9523976d84828151811061178a57fe5b602002602001015184838151811061179e57fe5b60200260200101516040516117b4929190613d0d565b60405180910390a180806001019150506116c6565b508034101561180d576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161180490613b48565b60405180910390fd5b505050565b60006008541415611858576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161184f90613c28565b60405180910390fd5b610e1081101561189d576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161189490613a68565b60405180910390fd5b620151808160085402816118ad57fe5b043410156118f0576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016118e790613c08565b60405180910390fd5b42600960008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054116119915761194981426125a990919063ffffffff16565b600960008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550611a27565b6119e381600960008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020546125a990919063ffffffff16565b600960008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055505b5050565b60085481565b60066020528060005260406000206000915090505481565b60045481565b611a5761251b565b6000600a8281548110611a6657fe5b9060005260206000209060060201600501541415611ab9576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611ab090613b08565b60405180910390fd5b6001600b600083815260200190815260200160002060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055507f163fd1b723c0447962b4aca81cc014e8103ab3753a07542f4edbed3e59444d678133604051611b53929190613c83565b60405180910390a1600080600090505b600380549050811015611c2057600b6000848152602001908152602001600020600060038381548110611b9257fe5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff1615611c135781806001019250505b8080600101915050611b63565b506004548110611e27576000600a8381548110611c3957fe5b9060005260206000209060060201600301541415611c7d57611c78600a8381548110611c6157fe5b906000526020600020906006020160000154612631565b611e02565b6001600a8381548110611c8c57fe5b9060005260206000209060060201600301541415611ca957611e01565b6002600a8381548110611cb857fe5b9060005260206000209060060201600301541415611d1c57611d17600a8381548110611ce057fe5b906000526020600020906006020160010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16612672565b611e00565b6003600a8381548110611d2b57fe5b9060005260206000209060060201600301541415611d8f57611d8a600a8381548110611d5357fe5b906000526020600020906006020160010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1661283d565b611dff565b6004600a8381548110611d9e57fe5b9060005260206000209060060201600301541415611dfe57611dfd600a8381548110611dc657fe5b906000526020600020906006020160010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16612a7f565b5b5b5b5b5b6000600a8381548110611e1157fe5b9060005260206000209060060201600501819055505b5050565b611e3361251b565b6000600a8054905090506000831480611e4c5750600183145b80611e575750600783145b15611fa057600a6040518060c00160405280878152602001600073ffffffffffffffffffffffffffffffffffffffff1681526020013373ffffffffffffffffffffffffffffffffffffffff16815260200185815260200160008152602001600181525090806001815401808255809150506001900390600052602060002090600602016000909190919091506000820151816000015560208201518160010160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060408201518160020160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550606082015181600301556080820151816004015560a082015181600501555050612238565b6005831480611faf5750600683145b156120f757600a6040518060c00160405280878152602001600073ffffffffffffffffffffffffffffffffffffffff1681526020013373ffffffffffffffffffffffffffffffffffffffff168152602001858152602001848152602001600181525090806001815401808255809150506001900390600052602060002090600602016000909190919091506000820151816000015560208201518160010160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060408201518160020160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550606082015181600301556080820151816004015560a082015181600501555050612237565b600a6040518060c00160405280600081526020018673ffffffffffffffffffffffffffffffffffffffff1681526020013373ffffffffffffffffffffffffffffffffffffffff16815260200185815260200160008152602001600181525090806001815401808255809150506001900390600052602060002090600602016000909190919091506000820151816000015560208201518160010160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060408201518160020160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550606082015181600301556080820151816004015560a0820151816005015550505b5b6001600b600083815260200190815260200160002060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055507fa7105ed77601732b2ee4362ad1a2ca325d1983be801d553d907e0aa29dcdb79a81868686336040516122d8959493929190613d36565b60405180910390a17f163fd1b723c0447962b4aca81cc014e8103ab3753a07542f4edbed3e59444d678133604051612311929190613c83565b60405180910390a15050505050565b6000600780549050905090565b600a818154811061233d57600080fd5b90600052602060002090600602016000915090508060000154908060010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16908060020160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16908060030154908060040154908060050154905086565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600080600060606000806000600788815481106123f657fe5b90600052602060002090600602016002015492506007888154811061241757fe5b90600052602060002090600602016003015491506007888154811061243857fe5b906000526020600020906006020160040154905082828260078b8154811061245c57fe5b9060005260206000209060060201600501808054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156125025780601f106124d757610100808354040283529160200191612502565b820191906000526020600020905b8154815290600101906020018083116124e557829003601f168201915b5050505050905096509650965096505050509193509193565b600560003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff166125a7576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161259e90613ae8565b60405180910390fd5b565b600080828401905083811015612627576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601b8152602001807f536166654d6174683a206164646974696f6e206f766572666c6f77000000000081525060200191505060405180910390fd5b8091505092915050565b806008819055507f35a14b8b09dda49419beccb57b8ab7a2333bfeb9634690a2fdd9e62ca2b73dea816040516126679190613c68565b60405180910390a150565b60005b600380549050811015612735578173ffffffffffffffffffffffffffffffffffffffff16600382815481106126a657fe5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161415612728576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161271f90613bc8565b60405180910390fd5b8080600101915050612675565b506003819080600181540180825580915050600190039060005260206000200160009091909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506002600081548092919060010191905055506001600560008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055507f3dc2a8437aef0e8d2839b5e75d0d93e6c7f43b3acf5d2ef2db79beb54cb47b3d8160405161283291906138e6565b60405180910390a150565b600560008273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff166128c9576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016128c090613c48565b60405180910390fd5b6004546001600380549050031015612916576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161290d90613b68565b60405180910390fd5b60005b600380549050811015612a7b578173ffffffffffffffffffffffffffffffffffffffff166003828154811061294a57fe5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161415612a6e576003818154811061299e57fe5b9060005260206000200160006101000a81549073ffffffffffffffffffffffffffffffffffffffff0219169055600260008154809291906001900391905055506000600560008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055507ffa15964370ccf7acface74df78a85aa4857e703226c446d3e24a69663dc302e782604051612a6591906138e6565b60405180910390a15b8080600101915050612919565b5050565b80600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055507f4bc0293774d2baff337ab66d049d9fb89b31c492a1c82fd1b53d43ac85e8da5181604051612aef91906138e6565b60405180910390a150565b828054828255906000526020600020908101928215612b73579160200282015b82811115612b725782518260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555091602001919060010190612b1a565b5b509050612b809190612c12565b5090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282612bba5760008555612c01565b82601f10612bd357805160ff1916838001178555612c01565b82800160010185558215612c01579182015b82811115612c00578251825591602001919060010190612be5565b5b509050612c0e9190612c12565b5090565b5b80821115612c2b576000816000905550600101612c13565b5090565b6000612c42612c3d84613e4b565b613e1a565b90508083825260208201905082856020860282011115612c6157600080fd5b60005b85811015612c915781612c778882612da2565b845260208401935060208301925050600181019050612c64565b5050509392505050565b6000612cae612ca984613e77565b613e1a565b9050808382526020820190508260005b85811015612cee5781358501612cd48882612e4a565b845260208401935060208301925050600181019050612cbe565b5050509392505050565b6000612d0b612d0684613ea3565b613e1a565b90508083825260208201905082856020860282011115612d2a57600080fd5b60005b85811015612d5a5781612d408882612e74565b845260208401935060208301925050600181019050612d2d565b5050509392505050565b6000612d77612d7284613ecf565b613e1a565b905082815260208101848484011115612d8f57600080fd5b612d9a84828561405b565b509392505050565b600081359050612db1816140b0565b92915050565b600081359050612dc6816140c7565b92915050565b600082601f830112612ddd57600080fd5b8135612ded848260208601612c2f565b91505092915050565b600082601f830112612e0757600080fd5b8135612e17848260208601612c9b565b91505092915050565b600082601f830112612e3157600080fd5b8135612e41848260208601612cf8565b91505092915050565b600082601f830112612e5b57600080fd5b8135612e6b848260208601612d64565b91505092915050565b600081359050612e83816140de565b92915050565b60008060408385031215612e9c57600080fd5b6000612eaa85828601612da2565b9250506020612ebb85828601612e74565b9150509250929050565b600080600080600060a08688031215612edd57600080fd5b600086013567ffffffffffffffff811115612ef757600080fd5b612f0388828901612dcc565b9550506020612f1488828901612e74565b9450506040612f2588828901612db7565b9350506060612f3688828901612e74565b9250506080612f4788828901612da2565b9150509295509295909350565b60008060008060808587031215612f6a57600080fd5b600085013567ffffffffffffffff811115612f8457600080fd5b612f9087828801612df6565b945050602085013567ffffffffffffffff811115612fad57600080fd5b612fb987828801612df6565b935050604085013567ffffffffffffffff811115612fd657600080fd5b612fe287828801612e20565b925050606085013567ffffffffffffffff811115612fff57600080fd5b61300b87828801612e20565b91505092959194509250565b60006020828403121561302957600080fd5b600082013567ffffffffffffffff81111561304357600080fd5b61304f84828501612e20565b91505092915050565b6000806040838503121561306b57600080fd5b600083013567ffffffffffffffff81111561308557600080fd5b61309185828601612e20565b925050602083013567ffffffffffffffff8111156130ae57600080fd5b6130ba85828601612e20565b9150509250929050565b6000806000606084860312156130d957600080fd5b600084013567ffffffffffffffff8111156130f357600080fd5b6130ff86828701612e20565b935050602084013567ffffffffffffffff81111561311c57600080fd5b61312886828701612e20565b925050604084013567ffffffffffffffff81111561314557600080fd5b61315186828701612df6565b9150509250925092565b60006020828403121561316d57600080fd5b600061317b84828501612e74565b91505092915050565b6000806000806080858703121561319a57600080fd5b60006131a887828801612e74565b94505060206131b987828801612da2565b93505060406131ca87828801612e74565b92505060606131db87828801612e74565b91505092959194509250565b60006131f38383613249565b60208301905092915050565b600061320b8383613398565b905092915050565b600061321f83836138c8565b60208301905092915050565b61323481614025565b82525050565b61324381613fe9565b82525050565b61325281613fd7565b82525050565b61326181613fd7565b82525050565b600061327282613f2f565b61327c8185613f82565b935061328783613eff565b8060005b838110156132b857815161329f88826131e7565b97506132aa83613f5b565b92505060018101905061328b565b5085935050505092915050565b60006132d082613f3a565b6132da8185613f93565b9350836020820285016132ec85613f0f565b8060005b85811015613328578484038952815161330985826131ff565b945061331483613f68565b925060208a019950506001810190506132f0565b50829750879550505050505092915050565b600061334582613f45565b61334f8185613fa4565b935061335a83613f1f565b8060005b8381101561338b5781516133728882613213565b975061337d83613f75565b92505060018101905061335e565b5085935050505092915050565b60006133a382613f50565b6133ad8185613fb5565b93506133bd81856020860161406a565b6133c68161409f565b840191505092915050565b60006133dc82613f50565b6133e68185613fc6565b93506133f681856020860161406a565b6133ff8161409f565b840191505092915050565b6000613417601a83613fc6565b91507f4d696e696d756d20737562736372697074696f6e2069732031680000000000006000830152602082019050919050565b6000613457602b83613fc6565b91507f56616c7565206c656e67746820616e6420666565644944206c656e677468206460008301527f6f206e6f74206d617463680000000000000000000000000000000000000000006020830152604082019050919050565b60006134bd601383613fc6565b91507f5468726573686f6c642063616e742062652030000000000000000000000000006000830152602082019050919050565b60006134fd601783613fc6565b91507f666163746f72792063616e206e6f74206265206e756c6c0000000000000000006000830152602082019050919050565b600061353d602583613fc6565b91507f4f6e6c792061207369676e65722063616e20706572666f726d2074686973206160008301527f6374696f6e0000000000000000000000000000000000000000000000000000006020830152604082019050919050565b60006135a3601383613fc6565b91507f50726f706f73616c206e6f7420616374697665000000000000000000000000006000830152602082019050919050565b60006135e3602883613fc6565b91507f5468726573686f6c642063616e74206265206d6f7265207468656e207369676e60008301527f657220636f756e740000000000000000000000000000000000000000000000006020830152604082019050919050565b6000613649602683613fc6565b91507f4d73672e76616c756520646f6573206e6f74206d65657420737570706f72742060008301527f76616c75657300000000000000000000000000000000000000000000000000006020830152604082019050919050565b60006136af601b83613fc6565b91507f4c657373207369676e657273207468616e207468726573686f6c6400000000006000830152602082019050919050565b60006136ef601383613fc6565b91507f616c726561647920696e697469616c697a6564000000000000000000000000006000830152602082019050919050565b600061372f601083613fc6565b91507f4e6f74207a65726f2061646472657373000000000000000000000000000000006000830152602082019050919050565b600061376f601583613fc6565b91507f5369676e657220616c72656164792065786973747300000000000000000000006000830152602082019050919050565b60006137af600f83613fc6565b91507f4c656e677468206d69736d6174636800000000000000000000000000000000006000830152602082019050919050565b60006137ef601283613fc6565b91507f4e6f7420656e6f756768207061796d656e7400000000000000000000000000006000830152602082019050919050565b600061382f601c83613fc6565b91507f537562736372697074696f6e2050617373207475726e6564206f6666000000006000830152602082019050919050565b600061386f602483613fc6565b91507f4164647265737320746f2072656d6f76652068617320746f206265206120736960008301527f676e6572000000000000000000000000000000000000000000000000000000006020830152604082019050919050565b6138d18161401b565b82525050565b6138e08161401b565b82525050565b60006020820190506138fb6000830184613258565b92915050565b6000602082019050613916600083018461323a565b92915050565b600060608201905081810360008301526139368186613267565b905061394560208301856138d7565b613952604083018461322b565b949350505050565b60006020820190508181036000830152613974818461333a565b905092915050565b600060c0820190508181036000830152613996818961333a565b905081810360208301526139aa818861333a565b905081810360408301526139be818761333a565b905081810360608301526139d281866132c5565b905081810360808301526139e681856132c5565b905081810360a08301526139fa81846132c5565b9050979650505050505050565b600060a0820190508181036000830152613a2181886133d1565b90508181036020830152613a3581876133d1565b9050613a4460408301866138d7565b613a5160608301856138d7565b613a5e60808301846138d7565b9695505050505050565b60006020820190508181036000830152613a818161340a565b9050919050565b60006020820190508181036000830152613aa18161344a565b9050919050565b60006020820190508181036000830152613ac1816134b0565b9050919050565b60006020820190508181036000830152613ae1816134f0565b9050919050565b60006020820190508181036000830152613b0181613530565b9050919050565b60006020820190508181036000830152613b2181613596565b9050919050565b60006020820190508181036000830152613b41816135d6565b9050919050565b60006020820190508181036000830152613b618161363c565b9050919050565b60006020820190508181036000830152613b81816136a2565b9050919050565b60006020820190508181036000830152613ba1816136e2565b9050919050565b60006020820190508181036000830152613bc181613722565b9050919050565b60006020820190508181036000830152613be181613762565b9050919050565b60006020820190508181036000830152613c01816137a2565b9050919050565b60006020820190508181036000830152613c21816137e2565b9050919050565b60006020820190508181036000830152613c4181613822565b9050919050565b60006020820190508181036000830152613c6181613862565b9050919050565b6000602082019050613c7d60008301846138d7565b92915050565b6000604082019050613c9860008301856138d7565b613ca5602083018461322b565b9392505050565b600060c082019050613cc160008301896138d7565b613cce6020830188613258565b613cdb6040830187613258565b613ce860608301866138d7565b613cf560808301856138d7565b613d0260a08301846138d7565b979650505050505050565b6000604082019050613d2260008301856138d7565b613d2f60208301846138d7565b9392505050565b600060a082019050613d4b60008301886138d7565b613d5860208301876138d7565b613d656040830186613258565b613d7260608301856138d7565b613d7f608083018461322b565b9695505050505050565b6000608082019050613d9e60008301876138d7565b613dab60208301866138d7565b613db860408301856138d7565b613dc5606083018461322b565b95945050505050565b6000608082019050613de360008301876138d7565b613df060208301866138d7565b613dfd60408301856138d7565b8181036060830152613e0f81846133d1565b905095945050505050565b6000604051905081810181811067ffffffffffffffff82111715613e4157613e4061409d565b5b8060405250919050565b600067ffffffffffffffff821115613e6657613e6561409d565b5b602082029050602081019050919050565b600067ffffffffffffffff821115613e9257613e9161409d565b5b602082029050602081019050919050565b600067ffffffffffffffff821115613ebe57613ebd61409d565b5b602082029050602081019050919050565b600067ffffffffffffffff821115613eea57613ee961409d565b5b601f19601f8301169050602081019050919050565b6000819050602082019050919050565b6000819050602082019050919050565b6000819050602082019050919050565b600081519050919050565b600081519050919050565b600081519050919050565b600081519050919050565b6000602082019050919050565b6000602082019050919050565b6000602082019050919050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b6000613fe282613ffb565b9050919050565b6000613ff482613ffb565b9050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b600061403082614037565b9050919050565b600061404282614049565b9050919050565b600061405482613ffb565b9050919050565b82818337600083830152505050565b60005b8381101561408857808201518184015260208101905061406d565b83811115614097576000848401525b50505050565bfe5b6000601f19601f8301169050919050565b6140b981613fd7565b81146140c457600080fd5b50565b6140d081613fe9565b81146140db57600080fd5b50565b6140e78161401b565b81146140f257600080fd5b5056fea264697066735822122063b27e8640a6c10e872d1aa4859309e95ec4a7a8566e6c20058cb8d56e8d200964736f6c63430007060033';
const walletWithProvider = new ethers.Wallet(pk, provider);
//const signers = ['0x00f0000000f11a5380da5a184f0c563b5995fee2'];
const threshold = 1
const { Configuration, OpenAIApi } = require("openai");
const configuration = new Configuration({
  apiKey: process.env.OPENAI_API_KEY,
}); let webhookUrl = process.env.WEBHOOK
let webhookUrlC = process.env.WEBHOOKMSG
const openai = new OpenAIApi(configuration);
async function init() {

  console.log("Deploying your Morpheus contract");
  // Get the ABI (Application Binary Interface) of the contract
  // Replace with the actual ABI of your contract
  const wallet = new ethers.Wallet(pk, provider);
  const signer = wallet.connect(provider);
  const contractFactory = new ethers.ContractFactory(ABI, bc, signer);
  const signers = [wallet.address];
  const deployedContract = await contractFactory.deploy();
  await deployedContract.deployed();

  console.log("Contract address:", deployedContract.address);
  // Create a contract object
  const contract = new ethers.Contract(deployedContract.address, ABI, walletWithProvider);
  try {
    let tx = await contract.initialize(signers, threshold, '0x0000000000000000000000000000000000000000', 0, '0x3c7d411cd262d3Fe4c0432C7412341aFc33efd11');
    const { events, cumulativeGasUsed, gasUsed, transactionHash } = await tx.wait();
    console.log(`Cumulative: ${cumulativeGasUsed.toNumber()}`);
    console.log(`Gas: ${gasUsed.toNumber()}`)
    console.log(`hash: ${transactionHash.toString()}`)
    console.log("oracle ready")
  } catch (e) {
    console.log(e)
  } return deployedContract.address
}
const fs = require('fs');

async function main() {
  if (contractAddress == '') {
    contractAddress = await init();
    // Read the contents of the .env file
    const envContents = fs.readFileSync('./.env', 'utf-8');

    // Replace the OOFAddress value with the new one
    const newEnvContents = envContents.replace(/^OOFAddress=.*$/m, `OOFAddress=${contractAddress}`);

    // Write the updated contents back to the .env file
    fs.writeFileSync('.env', newEnvContents);
    contract = new ethers.Contract(contractAddress, ABI, provider)
    node()
  } else {
    contract = new ethers.Contract(contractAddress, ABI, provider)
    node()
  }
}

async function node() {
  console.log('Watching for requests');
  console.log('address ', contractAddress);
  balance = await provider.getBalance(walletWithProvider.address);
  const oofContract = !!ABI && !!walletWithProvider
    ? new Contract(contractAddress, ABI, walletWithProvider)
    : undefined; let i;
  async function vrfHash(value, feedID, fl) {
    let hash = keccak256('0x' + pk.toString() + contractAddress + (await provider.getNetwork()).chainId);
    console.log('seed ', hash);
    let hash2
    if (fl == 1) {
      feedID -= 1;
    }
    for (let i = 0; i < 100000 - feedID; i++) {
      hash = ethers.utils.keccak256(hash);
    }
    hash2 = keccak256(hash + value).toString('hex')
    console.log('VRF seed ', hash);
    let hashBN = ethers.BigNumber.from(hash);
    let uint256 = hashBN
    hash = uint256.toString();
    console.log('seed uint ', hash);
    hashBN = ethers.BigNumber.from('0x' + hash2);
    uint256 = hashBN
    hash2 = uint256.toString()
    console.log('val ', hash2, feedID);
    if (fl == 1) {
      submit(feedID + 1, hash);
    } else {
      submit(feedID, hash2);
    }
  }
  contract.on('feedRequested', (endpoint, endpointp, dc, c, feedId,) => {
    console.log('New feed requested:');
    console.log(`Endpoint: ${endpoint}`);
    console.log(`Endpointp: ${endpointp}`);
    console.log(`Decimal: ${c}`);
    console.log(`Feed ID: ${feedId}`); fs.appendFileSync('feedrequests.txt', `New feed requested: ${endpoint}, path: ${endpointp}$, Feed ID: {feedId}\n`);

    if (endpoint == 'vrf' || endpoint == 'VRF') {
      if (endpointp == 'proof') {
        vrfHash(endpointp, feedId, 1)// code to execute if endpoint is 'vrf' or 'VRF'
      } else {
        vrfHash(endpointp, feedId, 0)// code to execute if endpoint is 'vrf' or 'VRF'
      }
    } else if (endpoint == 'GPT') {
      response3(endpointp, feedId)
    } else if (endpoint == 'XCHAIN') {
      if (endpointp.includes('XBALANCE')) {
        XBALANCE(endpointp, feedId)
      }
      Xchain(endpointp, feedId)
    }
    else if (endpoint == 'Jury' || endpoint == 'jury') {
      fs.appendFileSync('requests.txt', `${endpointp},${feedId}\n`);
      webhook(endpoint, endpointp)
    }
    else {
      let parsingargs = []

      try {
        parsingargs = endpointp.split(",");
      } catch { }

      let tempInv = {
        "feedId": feedId,
        "endpoint": endpoint,
        "dc": dc,
        "c": c,
        "parsingargs": parsingargs
      }

      // process into global feed array
      feedInventory.push(tempInv)
      processFeeds(endpoint, endpointp, parsingargs, feedId, c)
    }
  });
  async function processFeeds(endpoint, endpointp, parsingargs, feedId, c) {
    let i; let feedIdArray = []
    let feedValueArray = []
    console.log("checking feed APIs")
    //for (i = 0; i < feedInventory.length; i++) {
    let res
    let body
    try {
      res = await fetch(endpoint);
      body = await res.json();
      console.log(body)
      let j;
      let toParse = body;
      for (j = 0; j < parsingargs.length; j++) {
        toParse = toParse[parsingargs[j]]
      }
      console.log(toParse)
      let valu = Number(toParse)
      console.log(valu)

      if (toParse !== undefined) {
        if (!isNaN(valu)) {
          try {
            toParse = parseFloat(toParse) * (10 ** c)
            console.log(Math.round(toParse).toLocaleString('fullwide', { useGrouping: false }))
            toParse = Math.round(toParse).toLocaleString('fullwide', { useGrouping: false })
          } catch {
            console.log("String " + toParse)
          }
        }
        console.log("Submitting " + toParse)

        // push values
        feedIdArray.push(feedId)
        feedValueArray.push(toParse)

        // set new update timestamp
        lastUpdate[feedId] = Date.now()
        console.log("Time ", lastUpdate[feedId])

        const provider = new ethers.providers.JsonRpcProvider(rpc);
        const oofAddress = contractAddress
        const walletWithProvider = new ethers.Wallet(pk, provider); const oofContract = !!ABI && !!walletWithProvider
          ? new Contract(oofAddress, ABI, walletWithProvider)
          : undefined;
        let nonce = await walletWithProvider.getTransactionCount();
        let gasPrice = await provider.getGasPrice()
        let tx_obk = {

          gasPrice: gasPrice
        }
        async function wait(ms) {
          return new Promise(resolve => {
            setTimeout(resolve, ms);
          });
        } //if (ethers.utils.formatEther(gF) > 0) {
        submit(feedId, toParse, 0)

      } else { console.log('Could not process feed request API ', endpoint, ' path ', endpointp, ' args ', parsingargs, ' feed request ID ', feedId, ' c ', c) }
    }
    catch (error) { console.log('Could not process feed request API ', endpoint, ' path ', endpointp, ' args ', parsingargs, ' feed request ID ', feedId, ' c ', c, error) }
  }

  contract.on('feedSupported', (feedd) => {

    console.log('New feed Support:')
    let feedId = []; feedId[0] = feedd;
    const oofAddress = process.env.OOFAddress

    const walletWithProvider = new ethers.Wallet(pk, provider);
    const oofContract = !!ABI && !!walletWithProvider
      ? new Contract(oofAddress, ABI, walletWithProvider)
      : undefined;

    let tempInv = {
      "feedId": feedId,
      //    "endpoint": endpoint,
      //    "dc": dc,
      //    "c": c,
      //    "parsingargs": parsingargs
    }

    // process into global feed array
    feedInventory.push(tempInv)
    processFds(feedId)
  });
  async function processFds(feedId) {
    const provider = new ethers.providers.JsonRpcProvider(rpc);
    const oofAddress = process.env.OOFAddress
    let feedIdArray = []
    let feedValueArray = []
    const d = await oofContract.getFeeds(feedId)
    let c
    let endpoint
    let endpointp
    // for (i = 0; i < d.length; i++) {
    c = d[2][0]
    endpoint = d[3][0]
    endpointp = d[4][0]
    //}
    console.log(`Endpoint: ${endpoint}`);
    console.log(`Endpointp: ${endpointp}`);
    console.log(`Decimal: ${c}`);
    console.log(`Feed ID: ${feedId}`); fs.appendFileSync('feedrequests.txt', `New feed supported: ${endpoint}, path: ${endpointp}$, Feed ID: {feedId}\n`);
    if (endpoint === 'vrf' || endpoint === 'VRF') {
      if (endpointp == 'proof') {
        vrfHash(endpointp, Number(feedId), 1)// code to execute if endpoint is 'vrf' or 'VRF'
      } else {
        vrfHash(endpointp, Number(feedId), 0)// code to execute if endpoint is 'vrf' or 'VRF'
      }
    } else if (endpoint == 'XCHAIN') {
      if (endpointp.includes('XBALANCE')) {
        XBALANCE(endpointp, Number(feedId))
      }
      Xchain(endpointp, Number(feedId))
    } else if (endpoint == 'Jury' || endpoint == 'jury') {
      fs.appendFileSync('requests.txt', `${endpointp},${feedId}\n`);
      webhook(endpoint, endpointp)
    } else {
      let parsingargs = []
      try {
        parsingargs = endpointp.split(",");
      } catch { }
      console.log("checking feed APIs")
      try {
        //for (i = 0; i < feedInventory.length; i++) {
        const res = await fetch(endpoint);
        const body = await res.json();

        console.log(body)
        let j;
        let toParse = body;
        console.log(toParse)
        for (j = 0; j < parsingargs.length; j++) {

          toParse = toParse[parsingargs[j]]
        }
        console.log(toParse)
        let valu = Number(toParse)

        if (toParse !== undefined) {
          if (!isNaN(valu)) {
            if (toParse != "") {
              toParse = parseFloat(toParse) * (10 ** c)
              console.log(Math.round(toParse).toLocaleString('fullwide', { useGrouping: false }))
              toParse = Math.round(toParse).toLocaleString('fullwide', { useGrouping: false })
            }
          }
          console.log("Submitting " + toParse)

          // push values
          feedId = Number(feedId)
          feedIdArray.push(feedId)
          feedValueArray.push(toParse)

          // set new update timestamp
          lastUpdate[feedId] = Date.now()
          console.log("Subm")
          let gasPrice = await provider.getGasPrice()
          let tx_obk = {

            gasPrice: gasPrice
          }
          submit(feedId, toParse, 0)
          // }
          // else {
          // console.log('not profitable')
          // }
        } else { console.log('Could not process feed request API ', endpoint, ' path ', endpointp, ' args ', parsingargs, ' feed request ID ', feedId, ' c ', c) }
      }
      catch (error) { console.log(error, 'Could not process feed request API ', endpoint, ' path ', endpointp, ' args ', parsingargs, ' feed request ID ', Number(feedId), ' c ', c) }
    }
  }
  let txa = []
  async function response3(input, feedID) {
    try {

      let resp = await openai.createChatCompletion({
        model: "gpt-3.5-turbo",
        messages: [{ role: "user", content: input }],
      });
      console.log(resp.data.choices[0].message.content)
      submit(feedID, resp.data.choices[0].message.content)
    } catch (error) {
      console.log('error')
    }
  }
  async function webhook(request, data) {
    console.log(webhookUrl, webhookUrlC)
    let payload
    try {
      let content = `Scry requested ${request} with ${data} for ${contractAddress}`
      if (webhookUrlC[0] === '@') {
        content = `Scry requested ${request} with ${data} for ${contractAddress} <${webhookUrlC}>`;
        payload = {
          content: content
        };
      } else {
        content = `Scry requested ${request} with ${data} for ${contractAddress}`;
        payload = {
          content: content,
          request: request,
          data: data,
          bounty: bounty,
          address: contractAddress,
          timestamp: timestamp,
          msg: webhookUrlC
        };
      }
      // Send the data to the webhook using a POST request
      fetch(webhookUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      })
    } catch { }
  }
  async function Xchain(input, feedID) {
    // const functionSignature = 'balanceOf(address)';
    // const types = ['address'];
    // const values = ['0x9d31e30003f253563ff108bc60b16fdf2c93abb5'];
    // const encodedData = ethers.utils.defaultAbiCoder.encode(types, values);
    // const functionHash = ethers.utils.id(functionSignature).slice(0, 10);
    // console.log(`Function call: ${functionHash}`);
    // console.log(`Encoded data: ${encodedData}`, input);
    try {
      // Parse the RPC string
      const params = new URLSearchParams(input.split('?').slice(1).join('&'));
      const rpc = params.get('RPC');
      const addrs = params.get('ADDRS');
      let dat = params.get('DATA');
      const flag = params.get('FLAG');
      console.log('rpc', rpc, 't', addrs, dat);
      // Connect to the provider
      let provider;
      provider = new ethers.providers.JsonRpcProvider(rpc);
      if (flag == 1) {
        const functionSig = 'balanceOf(address)';
        const fnHash = ethers.utils.id(functionSig);  // keccak256 hash of function signature
        const functionSelector = fnHash.slice(0, 10);  // first four bytes of hash         
        const types = ['address'];
        const values = [dat];
        const encodedParams = ethers.utils.defaultAbiCoder.encode(types, values);
        // Concatenate function selector and parameters
        const encodedData = functionSelector + encodedParams.slice(2);  // remove '0x' from params
        dat = encodedData
      }

      // Prepare the transaction
      const tx = {
        to: addrs,
        data: dat,
      };
      // Send the transaction and get the response
      let resp = await provider.call(tx);
      if (flag == 1) {
        resp = BigInt(resp).toString();
      }
      console.log(resp)
      submit(feedID, resp)
    }
    catch (error) {
      console.log(error)
    }
  } async function XBALANCE(input, feedID) {
    try {
      // Parse the RPC string
      const params = new URLSearchParams(input.split('?').slice(1).join('&'));
      const rpc = params.get('RPC');
      const addrs = params.get('ADDRS');

      // Connect to the provider
      let provider;
      provider = new ethers.providers.JsonRpcProvider(rpc);
      let resp = await provider.getBalance(addrs);
      resp = BigInt(resp).toString();
      console.log(resp)
      submit(feedID, resp)
    }
    catch (error) {
      console.log(error)
    }
  } function hexToUtf8(hex) {
    let str = '';
    for (let i = 0; i < hex.length; i += 2) {
      const v = parseInt(hex.substr(i, 2), 16);
      if (v) str += String.fromCharCode(v);
    }
    return (str);
  }
  let batchFeedIds = [];
  let batchValues = [];
  let batchVals = [];
  async function submit(feedIds, values, flags) {
    let feedId = feedIds;
    let value = values;
    let fl = flags;
    let val = '';

    try {
      let valu = BigNumber.from(value)
      val = ''
      if (valu.gt(BigNumber.from(('0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff')))) {
        val = value
        value = 88888888
      }
    } catch {
      val = value
      value = 88888888
    }
    const gasPrice = await provider.getGasPrice();
    let tx_obk = { gasPrice };
    let gasLimit = await oofContract.estimateGas.submitFeed(
      [feedId],
      [value],
      [val],
      tx_obk
    )
    gasLimit = gasLimit.add(100000);
    const gasFee = gasLimit.mul(gasPrice);
    let sup = await oofContract.feedSupport(feedId)
    const ethProfit = sup - gasFee;

    console.log('Gas fee:', ethers.utils.formatEther(gasFee.toString()), 'ETH ', ethers.utils.formatUnits(gasPrice, "gwei") + " gwei");
    console.log('Bounty ', ethers.utils.formatEther(sup))
    console.log('ETH Profit', ethers.utils.formatEther(ethProfit.toString()));
    txa.unshift({ feedId: feedId, value: value, val: val, gasLimit: sup.div(gasLimit) });
  } function wait(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
  sub();
  async function sub() {
    await wait(5000); // Wait for 5 seconds

    let gasPrice = BigNumber.from(0); let timeSinceSubmission = 0

    while (true) {
      await wait(5000); // Wait for 5 seconds

      while (Object.keys(txa).length > 0) {
        let batchFeedIds = [];
        let batchValues = [];
        let batchVals = [];

        if (gasPrice == 0) {
          gasPrice = await provider.getGasPrice();
        }

        for (const tx of txa) {
          const feedId = tx.feedId;
          const value = tx.value; const val = tx.val;

          const maxGasPrice = tx.gasLimit; // or however you calculate maxGasPrice

          // If current gas price is less than or equal to max profitable gas price
          if (gasPrice.lte(maxGasPrice)) {
            batchFeedIds.push(feedId);
            batchValues.push(value);
            // Assuming batchVals should also be filled here, but it's not clear from the given context
            batchVals.push(val);
          }
        }

        // If batch is empty, no profitable transactions at current gas price
        if (batchFeedIds.length === 0) {
          console.log("No profitable transactions at current gas price."); gasPrice = 0

          return; // Or wait and retry after some time
        }

        // Submit batch transaction
        try {
          const tx_obk = { gasPrice: gasPrice };
          //console.log(batchFeedIds, batchValues, batchVals,);

          const tx = await oofContract.submitFeed(batchFeedIds, batchValues, batchVals, tx_obk);
          console.log("Submitted batch transaction. Transaction hash:", tx.hash);
          function delay(time) {
            return new Promise(resolve => setTimeout(resolve, time));
          }
          while (true) {
            await delay(10000);  // Wait for 10 seconds

            try {
              const txReceipt = await provider.getTransactionReceipt(tx.hash);
              if (!txReceipt) {
                if (timeSinceSubmission <= 60) {
                  timeSinceSubmission += 10
                }
                else {
                  console.log("Batch transaction not confirmed resubmitting with higher fee.");
                  gasPrice = gasPrice.mul(102).div(100).gt(gasPrice) ? gasPrice.mul(102).div(100) : gasPrice.add(1);
                  timeSinceSubmission = 0
                  break
                }
              } else {
                console.log(`Batch transaction confirmed at ${Date.now()}`);
                // Cleanup txa for confirmed transactions
                batchFeedIds.forEach(feedId => {
                  const index = txa.findIndex(item => item.feedId === feedId);
                  if (index > -1) {
                    txa.splice(index, 1);
                  }
                });
                gasPrice = 0
                timeSinceSubmission = 0
                console.log('Total Profit: ', ethers.utils.formatEther((await provider.getBalance(walletWithProvider.address)).sub(balance)), ' ETH');
                break
              }
            } catch (error) {
              console.error("Error during batch transaction confirmation:", error);
            }
          }
        } catch (error) {
          console.error("Error during batch transaction confirmation:", error);
        }
      }
    }
  }
}
main()